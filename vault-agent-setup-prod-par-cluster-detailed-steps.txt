Steps to implement Hashicorp vault agent and configure in Paris Cluster
===================================================================

Referrance link:- 

https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-external-vault#install-the-vault-helm-chart-configured-to-address-an-external-vault

Create namespace
===============
kubectl create ns hashicorp-vault-agent

Create a image pull secret by using below command
===================================================
kubectl get secret articred --namespace=apm-prod -o yaml | sed 's/namespace: .*/namespace: hashicorp-vault-agent/' | kubectl apply -f -

list helm repos
===============
helm repo ls

[vcs_devops@ALNDAPASDJMP06 vault]$ helm repo ls
WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: ../../swedbank-prod-par-kube.config
NAME                    URL
rancher-stable          https://releases.rancher.com/server-charts/stable
appdynamics-charts      https://ciscodevnet.github.io/appdynamics-charts
elastic                 https://helm.elastic.co
hashicorp               https://helm.releases.hashicorp.com
jetstack                https://charts.jetstack.io
[vcs_devops@ALNDAPASDJMP06 vault]$

helm repo add hashicorp https://helm.releases.hashicorp.com


Search vault agent versions
============================
helm search repo hashicorp/vault --versions

[vcs_devops@ALNDAPASDJMP06 swedbank-prod-par-k8s]$ helm search repo hashicorp/vault --versions
WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: swedbank-prod-par-kube.config
NAME                                    CHART VERSION   APP VERSION     DESCRIPTION
hashicorp/vault                         0.24.1          1.13.1          Official HashiCorp Vault Chart
hashicorp/vault                         0.24.0          1.13.1          Official HashiCorp Vault Chart
hashicorp/vault                         0.23.0          1.12.1          Official HashiCorp Vault Chart
hashicorp/vault                         0.22.1          1.12.0          Official HashiCorp Vault Chart
hashicorp/vault                         0.22.0          1.11.3          Official HashiCorp Vault Chart
hashicorp/vault                         0.21.0          1.11.2          Official HashiCorp Vault Chart
hashicorp/vault                         0.20.1          1.10.3          Official HashiCorp Vault Chart
hashicorp/vault                         0.20.0          1.10.3          Official HashiCorp Vault Chart
hashicorp/vault                         0.19.0          1.9.2           Official HashiCorp Vault Chart
hashicorp/vault                         0.18.0          1.9.0           Official HashiCorp Vault Chart
hashicorp/vault                         0.17.1          1.8.4           Official HashiCorp Vault Chart
hashicorp/vault                         0.17.0          1.8.4           Official HashiCorp Vault Chart
hashicorp/vault                         0.16.1          1.8.3           Official HashiCorp Vault Chart
hashicorp/vault                         0.16.0          1.8.2           Official HashiCorp Vault Chart
hashicorp/vault                         0.15.0          1.8.1           Official HashiCorp Vault Chart
hashicorp/vault                         0.14.0          1.8.0           Official HashiCorp Vault Chart
hashicorp/vault                         0.13.0          1.7.3           Official HashiCorp Vault Chart
hashicorp/vault                         0.12.0          1.7.2           Official HashiCorp Vault Chart
hashicorp/vault                         0.11.0          1.7.0           Official HashiCorp Vault Chart
hashicorp/vault                         0.10.0          1.7.0           Official HashiCorp Vault Chart
hashicorp/vault                         0.9.1           1.6.2           Official HashiCorp Vault Chart
hashicorp/vault                         0.9.0           1.6.1           Official HashiCorp Vault Chart
hashicorp/vault                         0.8.0           1.5.4           Official HashiCorp Vault Chart
hashicorp/vault                         0.7.0           1.5.2           Official HashiCorp Vault Chart
hashicorp/vault                         0.6.0           1.4.2           Official HashiCorp Vault Chart
hashicorp/vault                         0.5.0                           Install and configure Vault on Kubernetes.
hashicorp/vault                         0.4.0                           Install and configure Vault on Kubernetes.
hashicorp/vault-secrets-operator        0.1.0           0.1.0           Official Vault Secrets Operator Chart


Download specific k8s version using helm
=========================================

helm fetch hashicorp/vault --untar --version 0.23.0

Update values.yaml
================
1.imagePullSecrets:
    - name: articred
  
2. image: artifactory-new-93bf8f5a14c88dd6.elb.eu-west-2.amazonaws.com:8082/images.common.virtual/hashicorp/vault-k8s:1.1.0

3. Global - >vaultExternalAddr: https://paris.hashicorp-vault.prodvficloud.net:8200

Install vault
============
Path: /home/vcs_devops/swedbank-prod-par-k8s/hashicorp-setup/vault

helm upgrade --install vault --namespace hashicorp-vault-agent -f values.yaml . 

[vcs_devops@ALNDAPASDJMP06 vault]$ helm upgrade --install vault --namespace hashicorp-vault-agent -f values.yaml .
WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: ../../swedbank-prod-par-kube.config
Release "vault" does not exist. Installing it now.
NAME: vault
LAST DEPLOYED: Tue Jul 18 08:12:22 2023
NAMESPACE: hashicorp-vault-agent
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://www.vaultproject.io/docs/


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
[vcs_devops@ALNDAPASDJMP06 vault]$
[vcs_devops@ALNDAPASDJMP06 vault]$ date
Tue Jul 18 08:12:25 UTC 2023
[vcs_devops@ALNDAPASDJMP06 vault]$
[vcs_devops@ALNDAPASDJMP06 vault]$

[vcs_devops@ALNDAPASDJMP06 vault]$ helm status vault -n hashicorp-vault-agent
WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: ../../swedbank-prod-par-kube.config
NAME: vault
LAST DEPLOYED: Tue Jul 18 08:12:22 2023
NAMESPACE: hashicorp-vault-agent
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://www.vaultproject.io/docs/


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault


[vcs_devops@ALNDAPASDJMP06 vault]$
[vcs_devops@ALNDAPASDJMP06 vault]$ helm ls -n hashicorp-vault-agent
WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: ../../swedbank-prod-par-kube.config
NAME    NAMESPACE               REVISION        UPDATED                                 STATUS          CHART           APP VERSION
vault   hashicorp-vault-agent   1               2023-07-18 08:12:22.211054511 +0000 UTC deployed        vault-0.23.0    1.12.1
[vcs_devops@ALNDAPASDJMP06 vault]$
[vcs_devops@ALNDAPASDJMP06 vault]$ date
Tue Jul 18 08:13:14 UTC 2023


Verify the pods
=============
[vcs_devops@ALNDAPASDJMP06 vault]$ kubectl get pods -n hashicorp-vault-agent
NAME                                    READY   STATUS    RESTARTS   AGE
vault-agent-injector-55845bcd98-khffx   1/1     Running   0          82s
[vcs_devops@ALNDAPASDJMP06 vault]$


Retrieve the token by using below command
=======================================
VAULT_HELM_SECRET_NAME=$(kubectl get secrets --output=json -n hashicorp-vault-agent | jq -r '.items[].metadata | select(.name|startswith("vault-token-")).name')


kubectl describe secret $VAULT_HELM_SECRET_NAME -n hashicorp-vault-agent

[vcs_devops@ALNDAPASDJMP06 swedbank-prod-par-k8s]$ kubectl describe secret $VAULT_HELM_SECRET_NAME -n hashicorp-vault-agent
Name:         vault-token-h4r48
Namespace:    hashicorp-vault-agent
Labels:       <none>
Annotations:  kubernetes.io/service-account.name: vault
              kubernetes.io/service-account.uid: 5cac975e-3dbf-45d4-9545-95175fb869e6

Type:  kubernetes.io/service-account-token

Data
====
ca.crt:     1017 bytes
namespace:  21 bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IjRFZ2RXRE02dko2cWY3S0ZJNVdXRFJOa185aWtRd0x0bVRnamNTYkJaVzAifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJoYXNoaWNvcnAtdmF1bHQtYWdlbnQiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlY3JldC5uYW1lIjoidmF1bHQtdG9rZW4taDRyNDgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoidmF1bHQiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI1Y2FjOTc1ZS0zZGJmLTQ1ZDQtOTU0NS05NTE3NWZiODY5ZTYiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6aGFzaGljb3JwLXZhdWx0LWFnZW50OnZhdWx0In0.ML2Hhy0hCKPVHzkk2iWYkm-o24VYa-T-2rEJOM1eb752OSS5H6VGUycIETtgXSUUMeVwVdTrWfqmySGX2k0inLa5yxr-WFZIguq76cZ2EXV11ICfoiFYs-B48rg6Sxd7_EYAd4ZGz_-ZdwEnoHoCs4m1suLziFJq0LlFD0vNHBJGBx2awgJaj5y9U80b_FdJWi-lrbj-Q_qEB0ZZGwbvI7GrVxtmBGArAVjcAAzkeQh4zgKfbRcvQytLsGfRtMIauf-YmmQMVEL1oSy7B-eFXbu85AS_446ayzQAOmp-cWjxB3PKz8kynsg3KROWZfzZdR-Irci9lUUkeih1JgVnAw
[vcs_devops@ALNDAPASDJMP06 swedbank-prod-par-k8s]$



https://paris.hashicorp-vault.prodvficloud.net:8200



PAris Cluster DNS name:
=====================
pim-rke-prd-int-par.prodvficloud.net


eyJhbGciOiJSUzI1NiIsImtpZCI6IjRFZ2RXRE02dko2cWY3S0ZJNVdXRFJOa185aWtRd0x0bVRnamNTYkJaVzAifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJoYXNoaWNvcnAtdmF1bHQtYWdlbnQiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlY3JldC5uYW1lIjoidmF1bHQtdG9rZW4taDRyNDgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoidmF1bHQiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI1Y2FjOTc1ZS0zZGJmLTQ1ZDQtOTU0NS05NTE3NWZiODY5ZTYiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6aGFzaGljb3JwLXZhdWx0LWFnZW50OnZhdWx0In0.ML2Hhy0hCKPVHzkk2iWYkm-o24VYa-T-2rEJOM1eb752OSS5H6VGUycIETtgXSUUMeVwVdTrWfqmySGX2k0inLa5yxr-WFZIguq76cZ2EXV11ICfoiFYs-B48rg6Sxd7_EYAd4ZGz_-ZdwEnoHoCs4m1suLziFJq0LlFD0vNHBJGBx2awgJaj5y9U80b_FdJWi-lrbj-Q_qEB0ZZGwbvI7GrVxtmBGArAVjcAAzkeQh4zgKfbRcvQytLsGfRtMIauf-YmmQMVEL1oSy7B-eFXbu85AS_446ayzQAOmp-cWjxB3PKz8kynsg3KROWZfzZdR-Irci9lUUkeih1JgVnAw

Login to Paris vault UI
========================
https://paris.hashicorp-vault.prodvficloud.net:8200/ui/vault/access?namespace=verifone%2Fgbx%2Fparis


Create one secret
==============
pims/data/dummy

Username: vault


Create a policy
++++++++++++++

Go to Policies --> Create ACL policy

Policy name: pims-read

Policy-details as below
-------------------------

path "pims/data/dummy" {
  capabilities = ["read"]
}

path "auth/kubernetes/login" {
  capabilities = ["read","list"]
}

# Manage auth methods broadly across Vault
path "auth/*" {
  capabilities = ["read", "update", "delete", "list", "sudo"]
}

-----------------------------------------------
Create a role
++++++++++++

Go to Access --> Kubernetes --> Create a role "pims"

Bound service account names:  *

Bound service account namespaces: *

Do Not Attach 'default' Policy To Generated Tokens : false

Generated Token's Policies: pims-read,default

Generated Token's Type : default


Once you created the roles --> go to configuration in the same page
=================================================================
Configuration --> configure

kubernetes Host: https://pim-rke-prd-int-par.prodvficloud.net

Kubernetes CA certifacte : certificates-chain.txt (This will find in donwstream cluster authorized certs)

Kubernetes options
   --> Token Reviewer JWT: ca.crt  (hashicorp service account token you can find by using below command)
   
   VAULT_HELM_SECRET_NAME=$(kubectl get secrets --output=json -n hashicorp-vault-agent | jq -r '.items[].metadata | select(.name|startswith("vault-token-")).name')
   
   kubectl describe secret $VAULT_HELM_SECRET_NAME -n hashicorp-vault-agent


Create a service account
========================
kubectl create sa internal-app -n hashicorp-vault-agent

Create a test application to validate authentication
==================================================
apiVersion: v1
kind: Pod
metadata:
  name: devwebapp-with-annotations
  labels:
    app: devwebapp-with-annotations
  annotations:
    vault.hashicorp.com/agent-inject: 'true'
    vault.hashicorp.com/role: 'pims'
    vault.hashicorp.com/namespace: 'verifone/gbx/paris'     
    vault.hashicorp.com/agent-inject-secret-credentials.txt: 'pims/data/dummy'
    vault.hashicorp.com/tls-skip-verify: 'true' 
spec:
  serviceAccountName: internal-app
  containers:
    - name: app
      image: burtlo/devwebapp-ruby:k8s

kubectl apply -f vault-pod.yaml -n hashicorp-vault-agent


Verify the pods
==============
[vcs_devops@ALNDAPASDJMP06 swedbank-prod-par-k8s]$
[vcs_devops@ALNDAPASDJMP06 swedbank-prod-par-k8s]$ kubectl get pods -n hashicorp-vault-agent
NAME                                    READY   STATUS    RESTARTS   AGE
devwebapp-with-annotations              2/2     Running   0          4m25s
vault-agent-injector-55845bcd98-khffx   1/1     Running   0          22h
[vcs_devops@ALNDAPASDJMP06 swedbank-prod-par-k8s]$


Verify the logs
============
[vcs_devops@ALNDAPASDJMP06 swedbank-prod-par-k8s]$
[vcs_devops@ALNDAPASDJMP06 swedbank-prod-par-k8s]$ kubectl logs -f devwebapp-with-annotations -c vault-agent-init -n hashicorp-vault-agent
==> Note: Vault Agent version does not match Vault server version. Vault Agent version: 1.13.1, Vault server version: 1.12.2+ent
==> Vault Agent started! Log data will stream in below:

==> Vault Agent configuration:

           Api Address 1: http://bufconn
                     Cgo: disabled
               Log Level: info
                 Version: Vault v1.13.1, built 2023-03-23T12:51:35Z
             Version Sha: 4472e4a3fbcc984b7e3dc48f5a8283f3efe6f282

2023-07-19T06:15:05.312Z [INFO]  agent.sink.file: creating file sink
2023-07-19T06:15:05.312Z [INFO]  agent.sink.file: file sink configured: path=/home/vault/.vault-token mode=-rw-r-----
2023-07-19T06:15:05.312Z [INFO]  agent.template.server: starting template server
2023-07-19T06:15:05.312Z [INFO]  agent.auth.handler: starting auth handler
2023-07-19T06:15:05.312Z [INFO]  agent.auth.handler: authenticating
2023-07-19T06:15:05.312Z [INFO]  agent.sink.server: starting sink server
2023-07-19T06:15:05.312Z [INFO] (runner) creating new runner (dry: false, once: false)
2023-07-19T06:15:05.312Z [WARN] (clients) disabling vault SSL verification
2023-07-19T06:15:05.312Z [WARN] (clients) disabling nomad SSL verification
2023-07-19T06:15:05.313Z [INFO] (runner) creating watcher
2023-07-19T06:15:05.357Z [INFO]  agent.auth.handler: authentication successful, sending token to sinks
2023-07-19T06:15:05.357Z [INFO]  agent.auth.handler: starting renewal process
2023-07-19T06:15:05.357Z [INFO]  agent.template.server: template server received new token
2023-07-19T06:15:05.357Z [INFO] (runner) stopping
2023-07-19T06:15:05.357Z [INFO] (runner) creating new runner (dry: false, once: false)
2023-07-19T06:15:05.357Z [WARN] (clients) disabling vault SSL verification
2023-07-19T06:15:05.357Z [WARN] (clients) disabling nomad SSL verification
2023-07-19T06:15:05.357Z [INFO]  agent.sink.file: token written: path=/home/vault/.vault-token
2023-07-19T06:15:05.357Z [INFO]  agent.sink.server: sink server stopped
2023-07-19T06:15:05.357Z [INFO]  agent: sinks finished, exiting
2023-07-19T06:15:05.357Z [INFO] (runner) creating watcher
2023-07-19T06:15:05.357Z [INFO] (runner) starting
2023-07-19T06:15:05.374Z [INFO]  agent.auth.handler: renewed auth token
2023-07-19T06:15:05.412Z [INFO] (runner) rendered "(dynamic)" => "/vault/secrets/credentials.txt"
2023-07-19T06:15:05.412Z [INFO] (runner) stopping
2023-07-19T06:15:05.412Z [INFO]  agent.template.server: template server stopped
2023-07-19T06:15:05.412Z [INFO] (runner) received finish
2023-07-19T06:15:05.412Z [INFO]  agent.auth.handler: shutdown triggered, stopping lifetime watcher
2023-07-19T06:15:05.412Z [INFO]  agent.auth.handler: auth handler stopped
[vcs_devops@ALNDAPASDJMP06 swedbank-prod-par-k8s]$
[vcs_devops@ALNDAPASDJMP06 swedbank-prod-par-k8s]$ date
Wed Jul 19 06:17:56 UTC 2023
[vcs_devops@ALNDAPASDJMP06 swedbank-prod-par-k8s]$
[vcs_devops@ALNDAPASDJMP06 swedbank-prod-par-k8s]$


Verify the vault secrets
=======================
[vcs_devops@ALNDAPASDJMP06 swedbank-prod-par-k8s]$ kubectl exec -it devwebapp-with-annotations -n hashicorp-vault-agent -c app bash
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
root@devwebapp-with-annotations:/app#
root@devwebapp-with-annotations:/app# ls
Gemfile  Gemfile.lock  config.ru  lib
root@devwebapp-with-annotations:/app#
root@devwebapp-with-annotations:/app# ls
Gemfile  Gemfile.lock  config.ru  lib
root@devwebapp-with-annotations:/app#
root@devwebapp-with-annotations:/app# pwd
/app
root@devwebapp-with-annotations:/app# cd /vault
root@devwebapp-with-annotations:/vault# ls
secrets
root@devwebapp-with-annotations:/vault# cd secrets/
root@devwebapp-with-annotations:/vault/secrets# ls
credentials.txt
root@devwebapp-with-annotations:/vault/secrets# cat credentials.txt
data: map[Username:Vault]
metadata: map[created_time:2023-07-18T09:42:31.408499479Z custom_metadata:<nil> deletion_time: destroyed:false version:1]

exit

  
